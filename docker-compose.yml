services:

  serviceregistry:
    build: ./service-registry
    image: '1993erick/serviceregistry:0.0.1'
    container_name: serviceregistry
    ports:
      - '8761:8761'
    networks:
      - backend
    depends_on:
      - zipkin

  configserver:
    build: ./configserver
    image: '1993erick/configserver:0.0.1'
    container_name: configserver
    ports:
      - '9296:9296'
    #environment:
      #- EUREKA_SERVER_ADDRESS=http://serviceregistry:8761/eureka
    networks:
      - backend
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://configserver:9296/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - serviceregistry

  apigateway:
    build: ./apigateway
    image: '1993erick/apigateway:0.0.1'
    container_name: apigateway
    ports:
      - '9090:9090'
    environment:
      - EUREKA_SERVER_ADDRESS=http://serviceregistry:8761/eureka
      - CONFIG_SERVER_URL=configserver
      - ZIPKIN_URL=http://zipkin:9411
      - REDIS_URL=redis://redis:6379
    networks:
      - backend
    depends_on:
      - configserver
      - zipkin
      - redis
      - serviceregistry


  zipkin:
    image: openzipkin/zipkin
    ports:
      - "9411:9411"
    networks:
      - backend

  redis:
    image: redis
    ports:
      - "6379:6379"


  authservice:
    build: ./auth-service
    image: '1993erick/authservice:0.0.1'
    container_name: authservice
    ports:
      - '7777:7777'
    environment:
      - EUREKA_SERVER_ADDRESS=http://serviceregistry:8761/eureka
      - CONFIG_SERVER_URL=configserver
      - MYSQL_URL=jdbc:mysql://database:3306/userdb
      - MYSQL_USERNAME=springbootuser
      - MYSQL_PASSWORD=111111
    depends_on:
      mysql:
        condition: service_healthy
      configserver:
        condition: service_started
    networks:
      - backend


  productservice:
    build: ./productservice
    image: '1993erick/productservice:0.0.1'
    container_name: productservice
    ports:
      - '8081:8081'
    environment:
      - EUREKA_SERVER_ADDRESS=http://serviceregistry:8761/eureka
      - CONFIG_SERVER_URL=configserver
      - MYSQL_URL=jdbc:mysql://database:3306/productdb
      - MYSQL_USERNAME=springbootuser
      - MYSQL_PASSWORD=111111
      - ZIPKIN_URL=http://zipkin:9411
    depends_on:
      mysql:
        condition: service_healthy
      configserver:
        condition: service_started
      zipkin:
        condition: service_healthy
    networks:
      - backend

  orderservice:
    build: ./orderservice
    image: '1993erick/orderservice:0.0.1'
    container_name: orderservice
    ports:
      - '8082:8082'
    environment:
      - EUREKA_SERVER_ADDRESS=http://serviceregistry:8761/eureka
      - CONFIG_SERVER_URL=configserver
      #- MYSQL_URL=jdbc:mysql://database:3306/orderdb
      #- MYSQL_USERNAME=springbootuser
      #- MYSQL_PASSWORD=111111
      - ZIPKIN_URL=http://zipkin:9411
    networks:
      - backend
      - mysql
    depends_on:
      - mysql
      - configserver
      - zipkin
      #database:
        #condition: service_started
      #configserver:
        #condition: service_started
      #zipkin:
        #condition: service_healthy
      #serviceregistry:
        #condition : service_started



  paymentservice:
    build: ./paymentservice
    image: '1993erick/paymentservice:0.0.1'
    container_name: paymentservice
    ports:
      - '8083:8083'
    environment:
      - EUREKA_SERVER_ADDRESS=http://serviceregistry:8761/eureka
      - CONFIG_SERVER_URL=configserver
      - MYSQL_URL=jdbc:mysql://database:3306/paymentdb
      - MYSQL_USERNAME=springbootuser
      - MYSQL_PASSWORD=111111
      - ZIPKIN_URL=http://zipkin:9411
    depends_on:
      mysql:
        condition: service_healthy
      configserver:
        condition: service_started
      zipkin:
        condition: service_healthy
    networks:
      - backend


  mysql:
    container_name: mysql-database
    image: 'mysql:latest'
    ports:
      - "3306:3306"
    restart: always
    environment:
      MYSQL_ROOT_USER: root
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_USER: root
      MYSQL_PASSWORD: secret
    volumes:
      - mysql:/var/lib/mysql
    networks:
      - mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10


networks:
  backend:
    driver: bridge
  mysql:
    driver: bridge

volumes:
  mysql: